<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>El Bloque Constitucional: Modo Aventura üê¶‚öñÔ∏è</title>
  <style>
    body {
      margin: 0;
      background: #0b1020;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
    }

    h1 {
      margin: 10px 0;
      font-size: 22px;
      text-align: center;
    }

    #gameWrapper {
      position: relative;
    }

    #gameCanvas {
      background: linear-gradient(#7be0ff, #e0f8ff);
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      width: min(960px, 95vw);
      height: auto;
    }

    #hud {
      position: absolute;
      top: 6px;
      left: 8px;
      right: 8px;
      display: none;
      justify-content: space-between;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 3px #000;
      pointer-events: none;
    }

    #menu {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #musicControls {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: #ffe066;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.35);
      font-size: 13px;
    }

    button:hover {
      background: #ffea8a;
    }

    #questionBox {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }

    .overlayCard {
      background: rgba(10, 10, 25, 0.92);
      padding: 18px;
      border-radius: 12px;
      width: 80%;
      max-width: 380px;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.6);
    }

    .overlayCard h2 {
      margin: 0 0 10px;
      font-size: 16px;
    }

    .options {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .small {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h1>El Bloque Constitucional: Modo Aventura üê¶‚öñÔ∏è</h1>

  <div id="gameWrapper">
    <canvas id="gameCanvas" width="960" height="540"></canvas>

    <div id="hud">
      <span id="scoreLabel">Puntos: 0</span>
      <span id="difficultyLabel">Dificultad: -</span>
    </div>

    <div id="questionBox">
      <div class="overlayCard">
        <h2>¬°Ups! El pajarito choc√≥</h2>
        <p id="questionText"></p>

        <div class="options">
          <button class="optionBtn" data-index="0"></button>
          <button class="optionBtn" data-index="1"></button>
          <button class="optionBtn" data-index="2"></button>
          <button class="optionBtn" data-index="3"></button>
        </div>

        <p class="small">
          Si contest√°s bien, el pajarito vuelve a volar. Si no, termina.
        </p>
      </div>
    </div>
  </div>

  <div id="menu">
    <span style="font-size: 14px">Eleg√≠ dificultad:</span>
    <button data-diff="facil">F√°cil</button>
    <button data-diff="medio">Medio</button>
    <button data-diff="dificil">Dif√≠cil</button>
  </div>

  <div id="musicControls">
    <button id="musicToggleBtn">üéµ M√∫sica: ON</button>
    <button id="testSoundBtn">üîä Probar sonido</button>
  </div>

  <script>
    /*****************************************************
     * 1) PREGUNTAS - EXACTAS Y EN EL ORDEN QUE PEDISTE
     *****************************************************/
    const questionsPool = [
      { text:"El Bloque Constitucional Federal est√° compuesto por:", options:[
        "C√≥digos de fondo y tratados sin jerarqu√≠a",
        "Constituci√≥n Nacional + Tratados de DDHH con jerarqu√≠a constitucional",
        "Leyes nacionales","Sentencias de la Corte IDH"], correctIndex:1 },

      { text:"La jerarqu√≠a normativa puede graficarse como:", options:[
        "Un tri√°ngulo","Una pir√°mide","Un trapecio","Un rect√°ngulo"], correctIndex:2 },

      { text:"¬øQu√© caracter√≠stica distingue al Bloque Constitucional Federal?", options:[
        "Regula solo cuestiones civiles","Es la fuente jur√≠dica m√°s baja",
        "Goza de supremac√≠a frente a normas inferiores","Solo se aplica a casos penales"], correctIndex:2 },

      { text:"Los tratados internacionales con jerarqu√≠a constitucional fueron incorporados principalmente en:",
        options:["Reforma de 1957","Reforma de 1994","Reforma de 1860","Reforma de 2001"], correctIndex:1 },

      { text:"Las normas ubicadas en el nivel superior del sistema son generalmente:",
        options:["Detalladas","Breves y gen√©ricas","Solo para el ejecutivo","Municipales"], correctIndex:1 },

      { text:"El control de constitucionalidad argentino es:",
        options:["Concentrado","Difuso","Legislativo","Realizado por la Comisi√≥n IDH"], correctIndex:1 },

      { text:"¬øQui√©nes pueden ejercer control de constitucionalidad?",
        options:["Solo la Corte Suprema","Solo jueces federales","Todos los jueces","Los legisladores"], correctIndex:2 },

      { text:"La funci√≥n de no aplicar normas contrarias al Bloque Constitucional Federal es:",
        options:["Funci√≥n legislativa","Funci√≥n positiva","Funci√≥n negativa o represiva","Funci√≥n administrativa"], correctIndex:2 },

      { text:"El control de constitucionalidad tiene efectos:",
        options:["Erga omnes","Inter partes","Territoriales","Sobre todas las leyes"], correctIndex:1 },

      { text:"El caso Halabi constituye una excepci√≥n porque:",
        options:["No fue decidido por la Corte","Tuvo efecto colectivo","Invalid√≥ tratados","Elimin√≥ control"], correctIndex:1 },

      { text:"La Corte IDH se√±al√≥ en Almonacid Arellano que:",
        options:["Los jueces pueden ignorar SIDH","Aplicar normas contrarias",
        "Una norma local contraria a la CADH es inconvencional","El DI no sirve"], correctIndex:2 },

      { text:"El control de convencionalidad puede ser:",
        options:["Solo a petici√≥n","Solo de oficio","A petici√≥n o de oficio","Al final del proceso"], correctIndex:2 },

      { text:"¬øQu√© art. de la Constituci√≥n provincial de Tucum√°n regula el control constitucional?",
        options:["Const. Tucum√°n art 10","CPC art 87","Ley 24.660","Ley 6315"], correctIndex:1 },

      { text:"Una diferencia entre Corte IDH y Comisi√≥n IDH es que:",
        options:["Ambas litigiosas","La Comisi√≥n resuelve","La Corte dicta sentencias obligatorias","La Corte recomienda"], correctIndex:2 },

      { text:"Seg√∫n CSJN en Carranza Latrubesse, las recomendaciones de la Comisi√≥n IDH son:",
        options:["No vinculantes","Vinculantes"], correctIndex:0 },

      { text:"¬øEn el caso S.R.L., qu√© derecho reclamaba la accionante?",
        options:["Salidas","Trabajo","Estudiar carrera universitaria","Reducci√≥n"], correctIndex:2 },

      { text:"¬øQu√© tipo de acci√≥n present√≥ S.R.L.?",
        options:["Amparo","Casaci√≥n","Habeas corpus correctivo","Queja"], correctIndex:2 },

      { text:"El √∫nico derecho del que est√° privada una persona condenada es:",
        options:["Educaci√≥n","Salud","Libertad ambulatoria","Participaci√≥n pol√≠tica"], correctIndex:2 },

      { text:"El paradigma adecuado para interpretar el caso de S.R.L. es el de:",
        options:["Seguridad","Orden p√∫blico","Derechos Humanos","Prevenci√≥n"], correctIndex:2 },

      { text:"En el caso S.R.L. la CSJT determin√≥ que pedir informes al Servicio Penitenciario era:",
        options:["Siempre necesario","Prohibido",
        "No previsto y generaba demoras inconstitucionales","Irrelevante"], correctIndex:2 },

      { text:"La Ley nacional N¬∞ 26.206 establece que la educaci√≥n en encierro:",
        options:["Puede limitarse","Requiere autorizaci√≥n",
        "No admite limitaci√≥n por encierro","Depende del director"], correctIndex:2 },

      { text:"En el caso de S.R.L.el fundamento del derecho a estudiar seg√∫n la CSJT est√° en:",
        options:["Fines de la pena","Reinserci√≥n","La Condici√≥n humana","Presupuesto"], correctIndex:2 },

      { text:"En el caso de S.R.L. la CSJT orden√≥ al juez de ejecuci√≥n:",
        options:["Negar permisos","Nueva condena","Garantizar cursado y ex√°menes","M√°s informes"], correctIndex:2 },

      { text:"En el caso de S.R.L. el principal obst√°culo al ejericico del derecho fue:",
        options:["El transporte","La demora por informes penitenciarios","El cupo","La conducta"], correctIndex:1 },

      { text:"La Educaci√≥n en personas privadas de libertad est√° protegida por:",
        options:["Reglamentos","Constituci√≥n y tratados","Decretos","Informes"], correctIndex:1 },

      { text:"En el caso M.I.M. de L.P. y G.F.J. la jueza respecto del art. 562 CCyC declar√≥ su:",
        options:["Constitucionalidad","Inconstitucionalidad e inconvencionalidad parcial",
        "Inaplicabilidad","Derogaci√≥n"], correctIndex:1 },

      { text:"En el caso M.I.M. de L.P. y G.F.J. los peticionantes usaban Gestaci√≥n por Sustituci√≥n por:",
        options:["Cuestiones Laborales","Patolog√≠as que hac√≠an inviable el embarazo","Prohibici√≥n","Era m√°s econ√≥mico"], correctIndex:1 },

      { text:"En el caso M.I.M. de L.P. y G.F.J. la jueza fundament√≥ su posici√≥n en:",
        options:["Adm","Penal","Familia + salud reproductiva","Comercial"], correctIndex:2 },

      { text:"En el caso M.I.M. de L.P. y G.F.J. la filiaci√≥n se determin√≥ por:",
        options:["Gestante","Voluntad procreacional + gen√©tica","Registro civil","Plazos"], correctIndex:1 },

      { text:"En el caso M.I.M. de L.P. y G.F.J. la jueza destac√≥:",
        options:["Neutralidad","Inter√©s superior del ni√±o","Reserva de ley","Orden p√∫blico"], correctIndex:1 },

      { text:"La gestaci√≥n por sustituci√≥n no fue regulada porque:",
        options:["No exist√≠a","Requer√≠a debate interdisciplinario profundo","Era ilegal","No hab√≠a casos"], correctIndex:1 },

      { text:"En el caso M.I.M. de L.P. y G.F.J. la sentencia orden√≥ que el ni√±o/a sea:",
        options:["Hijo de gestante","Sin filiaci√≥n","Inscripto con apellidos gen√©ticos","Adoptabilidad"], correctIndex:2 },

      { text:"En el caso M.I.M. de L.P. y G.F.J. la inconstitucionalidad fue:",
        options:["Total","Parcial","Err√≥nea","Retroactiva"], correctIndex:1 },

      { text:"Cu√°l de los siguientes fallos es un conocido Leading case estadounidense?:",
        options:["Plessy","Brown","Marbury","Miranda"], correctIndex:2 },

      { text:"El primer antecedente argentino en materia de control judicial de constitucionalidad es:",
        options:["Halabi","Sojo","Carranza","Acosta"], correctIndex:1 },

      { text:"El caso Sojo versaba sobre:",
        options:["Culto","Expresi√≥n + prisi√≥n por Diputados","Educaci√≥n","Propiedad"], correctIndex:1 },

      { text:"Las Opiniones consultivas de la Corte IDH son:",
        options:["Obligatorias","Sin valor","Interpretaciones autorizadas","Disciplinarias"], correctIndex:2 },

      { text:"Las Sentencias de Corte IDH que no involucran a Argentina son:",
        options:["Obligatorias","Doctrina","No citables","Modifican leyes"], correctIndex:1 },

      { text:"La Comisi√≥n IDH emite:",
        options:["Sentencias","Opiniones y recomendaciones","√ìrdenes","Decretos"], correctIndex:1 },

      { text:"El control de constitucionalidad evita que:",
        options:["El poder judicial legisle","Se apliquen normas contrarias al bloque constitucional federal","Analicen tratados","Congreso regule"], correctIndex:1 },

      { text:"El Paradigma de seguridad en el caso S.R.L.:",
        options:["Reconoc√≠a derecho","Supeditaba a informes y conducta","Eliminaba educaci√≥n","Acceso inmediato"], correctIndex:1 },

      { text:"El trapecio constitucional representa:",
        options:["Niveles judiciales","Jerarqu√≠a normativa","Tipos de tratados","Proceso legislativo"], correctIndex:1 },

      { text:"EL caso S.R.L. es ejemplo de:",
        options:["Control correcto","Desconocimiento SIDH","Prohibici√≥n de estudiar"], correctIndex:0 },

      { text:"El Control judicial es un mecanismo:",
        options:["Adm","Legislativo","Interpoderes e intrapoder","Ejecutivo"], correctIndex:2 },

      { text:"En el caso del fallo sobre gestaci√≥n por sustituci√≥n la jueza sostuvo que el Estado debe:",
        options:["Interferir","Obstaculizar","No interferir y permitir salud reproductiva","Limitar ciencia"], correctIndex:2 },

      { text:"La educaci√≥n en c√°rceles debe ser:",
        options:["Restringida","Opcional","Sin discriminaci√≥n","Decidida por director"], correctIndex:2 },

      { text:"En el caso M.I.M. de L.P. y G.F.J. la jueza se fundament√≥ en tratados como:",
        options:["Convenci√≥n del Ni√±o + CEDAW","Viena","Varsovia","Ant√°rtico"], correctIndex:0 },
    ];

    /*****************************************************
     * 2) AUDIO - M√öSICA SOLO EN MEN√ö
     *****************************************************/
    const musicGame = new Audio("./flappy_flying_deep.wav");
    musicGame.loop = true;
    let musicStarted = false;
    let musicEnabled = true;
    const musicBaseVolume = 0.10;

    const sfxFlap  = new Audio("./sfx_flap_soft.wav");
    const sfxScore = new Audio("./sfx_score_popup.wav");
    const sfxHit   = new Audio("./sfx_damage.wav");

    let fadeAnimationId = null;
    function fadeMusicTo(targetVolume, durationMs = 600, pauseAtEnd = false) {
      if (!musicStarted) return;
      if (fadeAnimationId) cancelAnimationFrame(fadeAnimationId);

      const startVolume = musicGame.volume;
      const delta = targetVolume - startVolume;
      const startTime = performance.now();

      function step(now) {
        const t = Math.min(1, (now - startTime) / durationMs);
        musicGame.volume = startVolume + delta * t;

        if (t < 1) {
          fadeAnimationId = requestAnimationFrame(step);
        } else {
          fadeAnimationId = null;
          if (pauseAtEnd && targetVolume === 0) musicGame.pause();
        }
      }
      fadeAnimationId = requestAnimationFrame(step);
    }

    function ensureMenuMusic() {
      if (!musicEnabled) return;

      if (!musicStarted) {
        musicStarted = true;
        musicGame.currentTime = 0;
        musicGame.volume = 0;
        musicGame.play().then(() => {
          fadeMusicTo(musicBaseVolume, 800);
        }).catch(() => {});
      } else if (musicGame.paused) {
        musicGame.volume = 0;
        musicGame.play().then(() => {
          fadeMusicTo(musicBaseVolume, 800);
        }).catch(() => {});
      } else {
        fadeMusicTo(musicBaseVolume, 400);
      }
    }

    /*****************************************************
     * 3) VARIABLES PRINCIPALES
     *****************************************************/
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const hud = document.getElementById("hud");
    const scoreLabel = document.getElementById("scoreLabel");
    const difficultyLabel = document.getElementById("difficultyLabel");

    const menu = document.getElementById("menu");
    const menuButtons = document.querySelectorAll("button[data-diff]");

    const questionBox = document.getElementById("questionBox");
    const questionText = document.getElementById("questionText");
    const optionButtons = document.querySelectorAll(".optionBtn");

    const musicToggleBtn = document.getElementById("musicToggleBtn");
    const testSoundBtn   = document.getElementById("testSoundBtn");

    let gameState = "menu"; // menu | playing | question
    let currentDifficultyKey = null;
    let currentDifficulty = null;

    let frameCount = 0;
    let obstacles = [];
    let score = 0;
    let level = 1;

    let usedQuestionIndices = new Set();
    let currentQuestionIndex = null;

    const gravity = 0.35;
    const jumpStrength = -6.8;

    const bird = {
      x: canvas.width * 0.15,
      y: canvas.height * 0.5,
      vy: 0,
      width: 50,
      height: 38
    };

    const difficultyConfig = {
      facil:  { label:"F√°cil",  speed:2.2, gap:150, spawn:140 },
      medio:  { label:"Medio",  speed:3.1, gap:125, spawn:120 },
      dificil:{ label:"Dif√≠cil",speed:3.9, gap:105, spawn:105 }
    };

    let wingPhase = 0; // para la animaci√≥n de alas

    /*****************************************************
     * 4) FONDO: SOL + CONSTITUCI√ìN
     *****************************************************/
    function drawSunWithConstitution() {
      const cx = canvas.width - 120;
      const cy = 80;
      const radius = 50;

      ctx.save();
      ctx.translate(cx, cy);

      // Rayos
      ctx.strokeStyle = "#ffd93b";
      ctx.lineWidth = 4;
      for (let i = 0; i < 16; i++) {
        const angle = (Math.PI * 2 * i) / 16;
        const x1 = Math.cos(angle) * (radius + 6);
        const y1 = Math.sin(angle) * (radius + 6);
        const x2 = Math.cos(angle) * (radius + 18);
        const y2 = Math.sin(angle) * (radius + 18);
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }

      // Sol
      ctx.fillStyle = "#ffea3d";
      ctx.beginPath();
      ctx.arc(0, 0, radius, 0, Math.PI * 2);
      ctx.fill();

      // Librito de la Constituci√≥n
      const bookW = 40;
      const bookH = 32;

      ctx.fillStyle = "#ffffff";
      ctx.strokeStyle = "#1b1b1b";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.rect(-bookW / 2, -bookH / 2, bookW, bookH);
      ctx.fill();
      ctx.stroke();

      // Lomo celeste
      ctx.fillStyle = "#4dabff";
      ctx.fillRect(-bookW / 2, -bookH / 2, 8, bookH);

      // L√≠neas tipo p√°ginas
      ctx.strokeStyle = "#cccccc";
      ctx.lineWidth = 1;
      for (let i = -bookH / 2 + 6; i < bookH / 2 - 4; i += 5) {
        ctx.beginPath();
        ctx.moveTo(-bookW / 2 + 10, i);
        ctx.lineTo(bookW / 2 - 4, i);
        ctx.stroke();
      }

      // Letras "CN"
      ctx.fillStyle = "#000000";
      ctx.font = "bold 12px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("CN", 5, 0);

      ctx.restore();
    }

    function drawBackground() {
      ctx.fillStyle = "#7be0ff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      drawSunWithConstitution();

      ctx.fillStyle = "#63c368";
      ctx.fillRect(0, canvas.height - 40, canvas.width, 40);
    }

    /*****************************************************
     * 5) RESET & MEN√ö
     *****************************************************/
    function fullReset() {
      score = 0;
      frameCount = 0;
      obstacles = [];
      usedQuestionIndices.clear();
      level = 1;

      bird.x = canvas.width * 0.15;
      bird.y = canvas.height * 0.5;
      bird.vy = 0;

      scoreLabel.textContent = "Puntos: 0";
    }

    function softResetAfterQuestion() {
      frameCount = 0;
      obstacles = [];
      bird.x = canvas.width * 0.15;
      bird.y = canvas.height * 0.5;
      bird.vy = 0;
    }

    function goToMenu() {
      gameState = "menu";
      fullReset();
      hud.style.display = "none";
      menu.style.display = "flex";
      questionBox.style.display = "none";
      difficultyLabel.textContent = "Dificultad: -";

      ensureMenuMusic();
      draw();
    }

    function startGame(diffKey) {
      currentDifficultyKey = diffKey;
      currentDifficulty = difficultyConfig[diffKey];

      fullReset();
      hud.style.display = "flex";
      menu.style.display = "none";

      if (musicStarted) {
        fadeMusicTo(0, 700, true);
      }

      difficultyLabel.textContent = "Dificultad: " + currentDifficulty.label;
      gameState = "playing";
      loop();
    }

    /*****************************************************
     * 6) PREGUNTAS
     *****************************************************/
    function askQuestion() {
      const available = [...questionsPool.keys()].filter(
        i => !usedQuestionIndices.has(i)
      );

      if (available.length === 0) {
        alert("¬°Respondiste todas las preguntas! üéâ");
        goToMenu();
        return;
      }

      currentQuestionIndex =
        available[Math.floor(Math.random() * available.length)];
      usedQuestionIndices.add(currentQuestionIndex);

      const q = questionsPool[currentQuestionIndex];
      questionText.textContent = q.text;

      optionButtons.forEach((btn, i) => {
        btn.textContent = q.options[i] ?? "";
        btn.style.display = q.options[i] ? "block" : "none";
      });

      sfxHit.currentTime = 0;
      sfxHit.play();

      questionBox.style.display = "flex";
      gameState = "question";
    }

    function handleAnswer(idx) {
      const q = questionsPool[currentQuestionIndex];
      if (!q) return;

      if (idx === q.correctIndex) {
        questionBox.style.display = "none";
        alert("¬°Respuesta correcta! üê¶‚ú®");
        softResetAfterQuestion();
        gameState = "playing";
        loop();
      } else {
        alert("Respuesta incorrecta üí•");
        goToMenu();
      }
    }

    /*****************************************************
     * 7) INPUT
     *****************************************************/
    function flap() {
      if (gameState === "playing") {
        bird.vy = jumpStrength;
        sfxFlap.currentTime = 0;
        sfxFlap.play();
      }
    }

    window.addEventListener("keydown", e => {
      if (e.code === "Space") {
        e.preventDefault();
        flap();
      }
    });

    canvas.addEventListener("mousedown", flap);
    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      flap();
    }, { passive:false });

    /*****************************************************
     * 8) OBST√ÅCULOS (COMUNISTAS / ANARQUISTAS)
     *****************************************************/
    function spawnObstacle() {
      const gap = currentDifficulty.gap;
      const margin = 60;
      const centerY =
        margin + gap/2 + Math.random() * (canvas.height - 2*margin - gap);

      obstacles.push({
        x: canvas.width + 40,
        width: 70,
        gapY: centerY,
        gapHeight: gap,
        passed: false,
        style: Math.random() < 0.5 ? "comunista" : "anarquista"
      });
    }

    function drawCommunistDecor(x, y, w, h) {
      ctx.save();
      ctx.translate(x + w/2, y + h/2);

      // hoz
      ctx.beginPath();
      ctx.lineWidth = 5;
      ctx.strokeStyle = "#d62828";
      ctx.arc(0, 0, 22, Math.PI*0.2, Math.PI*1.3);
      ctx.stroke();

      // mango
      ctx.fillStyle = "#8b5a2b";
      ctx.fillRect(-4, -6, 8, 24);

      // martillo
      ctx.fillStyle = "#d62828";
      ctx.fillRect(-14, -3, 28, 6);
      ctx.fillRect(-3, -3, 6, 24);

      ctx.restore();
    }

    function drawAnarchistDecor(x, y, w, h) {
      ctx.save();
      ctx.translate(x + w/2, y + h/2);
      ctx.strokeStyle = "#000000";
      ctx.lineWidth = 6;

      // c√≠rculo
      ctx.beginPath();
      ctx.arc(0, 0, 22, 0, Math.PI * 2);
      ctx.stroke();

      // A
      ctx.beginPath();
      ctx.moveTo(0, -18);
      ctx.lineTo(-12, 18);
      ctx.lineTo(12, 18);
      ctx.closePath();
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(-14, 0);
      ctx.lineTo(14, 0);
      ctx.stroke();

      ctx.restore();
    }

    function drawObstacles() {
      ctx.fillStyle = "#0f766e";

      for (const o of obstacles) {
        const topH = o.gapY - o.gapHeight/2;
        const bottomY = o.gapY + o.gapHeight/2;

        // tubos rectangulares (hitbox perfecto)
        ctx.fillRect(o.x, 0, o.width, topH);
        ctx.fillRect(o.x, bottomY, o.width, canvas.height - bottomY);

        if (o.style === "comunista") {
          drawCommunistDecor(o.x, topH - 50, o.width, 50);
          drawCommunistDecor(o.x, bottomY, o.width, 50);
        } else {
          drawAnarchistDecor(o.x, topH - 50, o.width, 50);
          drawAnarchistDecor(o.x, bottomY, o.width, 50);
        }
      }
    }

    /*****************************************************
     * 9) COLISIONES
     *****************************************************/
    function checkCollisions() {
      if (bird.y < 0 || bird.y + bird.height > canvas.height - 40) {
        askQuestion();
        return;
      }

      for (const o of obstacles) {
        const topH = o.gapY - o.gapHeight/2;
        const bottomY = o.gapY + o.gapHeight/2;

        const bx1 = bird.x;
        const bx2 = bird.x + bird.width;
        const by1 = bird.y;
        const by2 = bird.y + bird.height;

        const ox1 = o.x;
        const ox2 = o.x + o.width;

        const overlapX = bx2 > ox1 && bx1 < ox2;
        const hitsTop = by1 < topH;
        const hitsBottom = by2 > bottomY;

        if (overlapX && (hitsTop || hitsBottom)) {
          askQuestion();
          return;
        }
      }
    }

    /*****************************************************
     * 10) P√ÅJARO (FLACO + ALAS ANIMADAS)
     *****************************************************/
    function drawBird() {
      const {x,y,width,height} = bird;

      ctx.save();
      const angle = Math.max(-0.4, Math.min(0.4, bird.vy * 0.03));
      ctx.translate(x + width/2, y + height/2);
      ctx.rotate(angle);

      // Cuerpo rojo flaco
      ctx.fillStyle = "#d62828";
      ctx.beginPath();
      ctx.ellipse(0, 0, (width/2) - 4, (height/2) + 2, 0, 0, Math.PI * 2);
      ctx.fill();

      // Alas / plumas verdes animadas
      const wingOffset = Math.sin(wingPhase) * 4;
      ctx.fillStyle = "#00ff55";

      // izquierda
      ctx.beginPath();
      ctx.ellipse(-width/2 + 4, wingOffset, 7, 13, 0, 0, Math.PI * 2);
      ctx.fill();

      // derecha
      ctx.beginPath();
      ctx.ellipse(width/2 - 4, -wingOffset, 7, 13, 0, 0, Math.PI * 2);
      ctx.fill();

      // panza blanca
      ctx.fillStyle = "#ffffff";
      ctx.beginPath();
      ctx.ellipse(0, height * 0.15, width/2.1, height/2.4, 0, 0, Math.PI*2);
      ctx.fill();

      // copito
      ctx.fillStyle = "#b21f2b";
      ctx.beginPath();
      ctx.moveTo(-4, -height/2 - 2);
      ctx.lineTo(2, -height/2 - 8);
      ctx.lineTo(8, -height/2 - 2);
      ctx.fill();

      // cola
      ctx.fillStyle = "#111";
      ctx.beginPath();
      ctx.moveTo(-width/2 - 6, 4);
      ctx.lineTo(-width/2 - 1, -2);
      ctx.lineTo(-width/2 + 3, 6);
      ctx.fill();

      // pico
      ctx.fillStyle = "#ffd52e";
      ctx.beginPath();
      ctx.moveTo(width/2 + 2, 0);
      ctx.lineTo(width/2 + 12, -5);
      ctx.lineTo(width/2 + 12, 5);
      ctx.fill();

      // ojo
      const eyeX = width * 0.15;
      const eyeY = -height * 0.15;
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(eyeX, eyeY, 4.8, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.arc(eyeX+1, eyeY+0.5, 2.2, 0, Math.PI*2);
      ctx.fill();

      // ceja
      ctx.fillStyle = "#111";
      ctx.save();
      ctx.translate(eyeX - 3, eyeY - 5);
      ctx.rotate(-0.2);
      ctx.fillRect(0, 0, 11, 2.5);
      ctx.restore();

      ctx.restore();
    }

    /*****************************************************
     * 11) DIBUJO GENERAL + LOOP
     *****************************************************/
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawBackground();
      drawObstacles();
      drawBird();
    }

    function loop() {
      if (gameState === "playing") {
        frameCount++;
        wingPhase += 0.25;

        bird.vy += gravity;
        bird.y += bird.vy;

        if (frameCount % currentDifficulty.spawn === 0) {
          spawnObstacle();
        }

        obstacles.forEach(o => {
          o.x -= currentDifficulty.speed;

          // sumar puntos al pasar el tubo
          if (!o.passed && o.x + o.width < bird.x) {
            o.passed = true;
            score++;
            scoreLabel.textContent = "Puntos: " + score;

            sfxScore.currentTime = 0;
            sfxScore.play();

            // cambios de nivel
            if (currentDifficultyKey === "facil" && level === 1 && score >= 15) {
              level = 2;
              alert("‚ú® Pasaste al Nivel Medio ‚ú®");
              currentDifficultyKey = "medio";
              currentDifficulty = difficultyConfig["medio"];
              obstacles = [];
              frameCount = 0;
            } else if (currentDifficultyKey === "medio" && level === 2 && score >= 30) {
              level = 3;
              alert("üî• Nivel Dif√≠cil activado üî•");
              currentDifficultyKey = "dificil";
              currentDifficulty = difficultyConfig["dificil"];
              obstacles = [];
              frameCount = 0;
            }
          }
        });

        checkCollisions();
      }

      draw();

      if (gameState === "playing") {
        requestAnimationFrame(loop);
      }
    }

    /*****************************************************
     * 12) EVENTOS DE INTERFAZ / M√öSICA
     *****************************************************/
    function updateMusicToggleLabel() {
      musicToggleBtn.textContent = musicEnabled
        ? "üéµ M√∫sica: ON"
        : "üéµ M√∫sica: OFF";
    }

    musicToggleBtn.addEventListener("click", () => {
      musicEnabled = !musicEnabled;
      updateMusicToggleLabel();

      if (musicEnabled) {
        ensureMenuMusic();
      } else if (musicStarted) {
        fadeMusicTo(0, 800, true);
      }
    });

    testSoundBtn.addEventListener("click", () => {
      ensureMenuMusic();
      sfxScore.currentTime = 0;
      sfxScore.play();
    });

    optionButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.dataset.index);
        if (gameState === "question") handleAnswer(idx);
      });
    });

    menuButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        startGame(btn.dataset.diff);
      });
    });

    /*****************************************************
     * 13) ARRANQUE
     *****************************************************/
    draw();
    updateMusicToggleLabel();
    ensureMenuMusic();
  </script>
</body>
</html>
