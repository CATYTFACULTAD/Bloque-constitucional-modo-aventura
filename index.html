<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>El Bloque Constitucional: Modo Aventura üê¶‚öñÔ∏è</title>
  <style>
    body {
      margin: 0;
      background: #0b1020;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
    }

    h1 {
      margin: 10px 0;
      font-size: 22px;
      text-align: center;
    }

    #gameWrapper {
      position: relative;
    }

    #gameCanvas {
        background: linear-gradient(#7be0ff, #e0f8ff);
        border-radius: 14px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        /* üëá fuerza que se vea grande en pantalla */
        width: min(960px, 95vw);
        height: auto;
    }

    #hud {
      position: absolute;
      top: 6px;
      left: 8px;
      right: 8px;
      display: none;
      justify-content: space-between;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 3px #000;
    }

    #menu {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }

    #musicControls {
      margin-top: 6px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: #ffe066;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.35);
      font-size: 13px;
    }

    button:hover {
      background: #ffea8a;
    }

    #questionBox {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
    }

    .overlayCard {
      background: rgba(10,10,25,0.92);
      padding: 18px;
      border-radius: 12px;
      width: 80%;
      max-width: 350px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.6);
    }

    .overlayCard h2 {
      margin: 0 0 10px;
      font-size: 16px;
    }

    .options {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .small { font-size: 12px; opacity: 0.8; margin-top: 10px; }
  </style>
</head>
<body>

<h1>El Bloque Constitucional: Modo Aventura üê¶‚öñÔ∏è</h1>

<div id="gameWrapper">
 <canvas id="gameCanvas" width="960" height="540"></canvas>

  <div id="hud">
    <span id="scoreLabel">Puntos: 0</span>
    <span id="difficultyLabel">Dificultad: -</span>
  </div>

  <!-- Caja de Preguntas -->
  <div id="questionBox">
    <div class="overlayCard">
      <h2>¬°Ups! El pajarito choc√≥</h2>
      <p id="questionText"></p>

      <div class="options">
        <button class="optionBtn" data-index="0"></button>
        <button class="optionBtn" data-index="1"></button>
        <button class="optionBtn" data-index="2"></button>
        <button class="optionBtn" data-index="3"></button>
      </div>

      <p class="small">Si contest√°s bien, el pajarito vuelve a volar. Si no, termina.</p>
    </div>
  </div>
</div>

<div id="menu">
  <span style="align-self:center;font-size:14px;">Eleg√≠ dificultad:</span>
  <button data-diff="facil">F√°cil</button>
  <button data-diff="medio">Medio</button>
  <button data-diff="dificil">Dif√≠cil</button>
</div>

<div id="musicControls">
  <button id="musicToggleBtn">üéµ M√∫sica: ON</button>
  <button id="testSoundBtn">üîä Probar sonido</button>
</div>

<script>
//////////////////////////////
// PREGUNTAS
//////////////////////////////
const questionsPool = [
  { text:"El Bloque Constitucional Federal est√° compuesto por:", options:[
    "C√≥digos de fondo y tratados sin jerarqu√≠a",
    "Constituci√≥n Nacional + Tratados de DDHH con jerarqu√≠a constitucional",
    "Leyes nacionales",
    "Sentencias de la Corte IDH"], correctIndex:1 },
  { text:"La jerarqu√≠a normativa puede graficarse como:", options:[
    "Un tri√°ngulo","Una pir√°mide","Un trapecio","Un rect√°ngulo"], correctIndex:2 },
  { text:"¬øQu√© caracter√≠stica distingue al Bloque Constitucional Federal?", options:[
    "Regula solo cuestiones civiles","Es la fuente jur√≠dica m√°s baja",
    "Goza de supremac√≠a frente a normas inferiores","Solo se aplica a casos penales"], correctIndex:2 },
  { text:"Los tratados internacionales con jerarqu√≠a constitucional fueron incorporados principalmente en:",
    options:["Reforma de 1957","Reforma de 1994","Reforma de 1860","Reforma de 2001"], correctIndex:1 },
  { text:"Las normas ubicadas en el nivel superior del sistema son generalmente:",
    options:["Detalladas","Breves y gen√©ricas","Solo para el ejecutivo","Municipales"], correctIndex:1 },
  { text:"El control de constitucionalidad argentino es:",
    options:["Concentrado","Difuso","Legislativo","Realizado por la Comisi√≥n IDH"], correctIndex:1 },
  { text:"¬øQui√©nes pueden ejercer control de constitucionalidad?",
    options:["Solo la Corte Suprema","Solo jueces federales","Todos los jueces","Los legisladores"], correctIndex:2 },
  { text:"La funci√≥n de no aplicar normas contrarias al Bloque Constitucional Federal es:",
    options:["Funci√≥n legislativa","Funci√≥n positiva","Funci√≥n negativa o represiva","Funci√≥n administrativa"], correctIndex:2 },
  { text:"El control de constitucionalidad tiene efectos:",
    options:["Erga omnes","Inter partes","Territoriales","Sobre todas las leyes"], correctIndex:1 },
  { text:"El caso Halabi constituye una excepci√≥n porque:",
    options:["No fue decidido por la Corte","Tuvo efecto colectivo","Invalid√≥ tratados","Elimin√≥ control"], correctIndex:1 },
  { text:"La Corte IDH se√±al√≥ en Almonacid Arellano que:",
    options:["Los jueces pueden ignorar SIDH","Aplicar normas contrarias",
    "Una norma local contraria a la CADH es inconvencional","El DI no sirve"], correctIndex:2 },
  { text:"El control de convencionalidad puede ser:",
    options:["Solo a petici√≥n","Solo de oficio","A petici√≥n o de oficio","Al final del proceso"], correctIndex:2 },
  { text:"¬øQu√© norma de Tucum√°n regula el control constitucional?",
    options:["Const. Tucum√°n art 10","CPC art 87","Ley 24.660","Ley 6315"], correctIndex:1 },
  { text:"Una diferencia entre Corte IDH y Comisi√≥n IDH es que:",
    options:["Ambas litigiosas","La Comisi√≥n resuelve","La Corte dicta sentencias obligatorias","La Corte recomienda"], correctIndex:2 },
  { text:"Seg√∫n CSJN en Carranza Latrubesse, las recomendaciones de la Comisi√≥n IDH son:",
    options:["No vinculantes","Vinculantes"], correctIndex:0 },
  { text:"¬øQu√© derecho reclamaba S.R.L.?",
    options:["Salidas","Trabajo","Estudiar carrera universitaria","Reducci√≥n"], correctIndex:2 },
  { text:"¬øQu√© tipo de acci√≥n present√≥ S.R.L.?",
    options:["Amparo","Casaci√≥n","Habeas corpus correctivo","Queja"], correctIndex:2 },
  { text:"El √∫nico derecho del que est√° privada una persona condenada es:",
    options:["Educaci√≥n","Salud","Libertad ambulatoria","Participaci√≥n pol√≠tica"], correctIndex:2 },
  { text:"El paradigma adecuado para interpretar el caso S.R.L. es:",
    options:["Seguridad","Orden p√∫blico","Derechos Humanos","Prevenci√≥n"], correctIndex:2 },
  { text:"La CSJT determin√≥ que pedir informes al SP:",
    options:["Siempre necesario","Prohibido","No previsto y generaba demoras inconstitucionales","Irrelevante"], correctIndex:2 },
  { text:"La Ley 26.206 establece que la educaci√≥n en encierro:",
    options:["Puede limitarse","Requiere autorizaci√≥n","No admite limitaci√≥n por encierro","Depende del director"], correctIndex:2 },
  { text:"En el caso S.R.L. y seg√∫n la CSJT el fundamento del derecho a estudiar es:",
    options:["Fines de la pena","Reinserci√≥n","Condici√≥n humana","Presupuesto"], correctIndex:2 },
  { text:"En el caso S.R.L. la CSJT orden√≥ al juez de ejecuci√≥n:",
    options:["Negar permisos","Nueva condena","Garantizar cursado y ex√°menes","M√°s informes"], correctIndex:2 },
  { text:"En el caso S.R.L. y seg√∫n la CSJT el Principal obst√°culo al ejercicio del derecho fue:",
    options:["Transporte","Demora por informes penitenciarios","Cupo","Conducta"], correctIndex:1 },
  { text:"La educaci√≥n en personas privadas de libertad est√° protegida por:",
    options:["Reglamentos","Constituci√≥n y tratados","Decretos","Informes"], correctIndex:1 },
  { text:"En el caso M.I.M de L.P y G.F.J. La jueza declar√≥ respecto del art. 562 CCyC :",
    options:["Constitucionalidad","Inconstitucionalidad e inconvencionalidad parcial","Inaplicabilidad","Derogaci√≥n"], correctIndex:1 },
  { text:"En el caso M.I.M de L.P y G.F.J.los peticionantes usaban Gestaci√≥n por Sustituci√≥n porque:",
    options:["Laboral","Patolog√≠as que hac√≠an inviable el embarazo","Prohibici√≥n","M√°s barata"], correctIndex:1 },
  { text:"En el caso M.I.M de L.P y G.F.J. la filiaci√≥n se determin√≥ por:",
    options:["Voluntad procreacional + gen√©tica","Registro civil","Plazos"], correctIndex:1 },
  { text:"En el caso M.I.M de L.P y G.F.J. la jueza destac√≥:",
    options:["Neutralidad","Inter√©s superior del ni√±o","Reserva de ley","Orden p√∫blico"], correctIndex:1 },
  { text:"En el caso M.I.M de L.P y G.F.J. la sentencia orden√≥ que el ni√±o/a sea:",
    options:["Hijo de gestante","Sin filiaci√≥n","Inscripto con apellidos gen√©ticos","Adoptabilidad"], correctIndex:2 },
  { text:"En el caso M.I.M de L.P y G.F.J. la inconstitucionalidad fue:",
    options:["Total","Parcial","Err√≥nea","Retroactiva"], correctIndex:1 },
  { text:"Cu√°l de los siguientes fallos es un Leading case estadounidense?:",
    options:["Plessy","Brown","Marbury","Miranda"], correctIndex:2 },
  { text:"Cu√°l de los siguientes fallos es el primer antecedente argentino en control jurisdiccional de constitucionalidad?:",
    options:["Halabi","Sojo","Carranza","Acosta"], correctIndex:1 },
  { text:"El caso Sojo versaba sobre:",
    options:["Culto","Expresi√≥n + prisi√≥n por Diputados","Educaci√≥n","Propiedad"], correctIndex:1 },
  { text:"Las Opiniones Consultivas de Corte IDH son:",
    options:["Obligatorias","Sin valor","Interpretaciones autorizadas","Disciplinarias"], correctIndex:2 },
  { text:"Las Sentencias de Corte IDH que no involucran a Argentina:",
    options:["Son de cumplimiento obligatorio para nuestro pa√≠s","Operan como Doctrina","Modifican leyes"], correctIndex:1 },
  { text:"La Comisi√≥n IDH emite:",
    options:["Sentencias","Opiniones y recomendaciones","√ìrdenes","Decretos"], correctIndex:1 },
  { text:"El control de constitucionalidad evita que:",
    options:["El poder judicial legisle","Se apliquen normas contrarias al bloque","Analicen tratados","Congreso regule"], correctIndex:1 },
  { text:"El Paradigma de seguridad en S.R.L.:",
    options:["Reconoc√≠a derecho","Supeditaba a informes y conducta","Eliminaba educaci√≥n","Acceso inmediato"], correctIndex:1 },
  { text:"El trapecio representa:",
    options:["Niveles judiciales","Jerarqu√≠a de fuentes normativas","Tipos de tratados","Procesos legislativos"], correctIndex:1 },
  { text:"El Control de Constitucionalidad es un mecanismo:",
    options:["Adm","Legislativo","Judicial","Ejecutivo"], correctIndex:2 },
  { text:"En el caso M.I.M de L.P y G.F.J. sobre Gestaci√≥n por Sustituci√≥n la jueza sostuvo que el Estado debe:",
    options:["Interferir","Obstaculizar","No interferir y permitir salud reproductiva","Limitar ciencia"], correctIndex:2 },
  { text:"La educaci√≥n en c√°rceles debe ser:",
    options:["Restringida","Opcional","Sin discriminaci√≥n","Decidida por director"], correctIndex:2 },
  { text:"En el caso M.I.M de L.P y G.F.J. sobre Gestaci√≥n por Sustituci√≥n la jueza us√≥ tratados como:",
    options:["Convenci√≥n del Ni√±o + CEDAW","Viena","Varsovia","Ant√°rtico"], correctIndex:0 },
];

//////////////////////////////
// AUDIO + FADES
//////////////////////////////

// ‚ö†Ô∏è Si tu archivo es MP3, cambi√° a "./flappy_flying_deep.mp3"
const musicGame = new Audio("./flappy_flying_deep.wav");
musicGame.loop = true;
let musicStarted = false;
let musicEnabled = true;
const musicBaseVolume = 0.30;   // volumen m√°s bajito a√∫n

const sfxFlap  = new Audio("./sfx_flap_soft.wav");
sfxFlap.volume = 0.8;

const sfxScore = new Audio("./sfx_score_popup.wav");
sfxScore.volume = 0.8;

const sfxHit   = new Audio("./sfx_damage.wav");
sfxHit.volume  = 0.8;

let fadeAnimationId = null;

function fadeMusicTo(targetVolume, durationMs = 600, pauseAtEnd = false) {
  if (!musicStarted) return;
  if (fadeAnimationId) cancelAnimationFrame(fadeAnimationId);

  const startVolume = musicGame.volume;
  const delta = targetVolume - startVolume;
  const startTime = performance.now();

  function step(now) {
    const t = Math.min(1, (now - startTime) / durationMs);
    musicGame.volume = startVolume + delta * t;

    if (t < 1) {
      fadeAnimationId = requestAnimationFrame(step);
    } else {
      fadeAnimationId = null;
      if (pauseAtEnd && targetVolume === 0) {
        musicGame.pause();
      }
    }
  }

  fadeAnimationId = requestAnimationFrame(step);
}

function ensureMusicPlaying() {
  if (!musicEnabled) return;

  if (!musicStarted) {
    musicStarted = true;
    musicGame.currentTime = 0;
    musicGame.volume = 0;
    musicGame.play().then(() => {
      fadeMusicTo(musicBaseVolume, 800);
    }).catch(() => {
      console.log("Autoplay bloqueado.");
    });
  } else if (musicGame.paused) {
    musicGame.volume = 0;
    musicGame.play().then(() => {
      fadeMusicTo(musicBaseVolume, 800);
    }).catch(() => {});
  } else {
    fadeMusicTo(musicBaseVolume, 400);
  }
}

//////////////////////////////
// VARIABLES DEL JUEGO
//////////////////////////////

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const hud = document.getElementById("hud");
const scoreLabel = document.getElementById("scoreLabel");
const difficultyLabel = document.getElementById("difficultyLabel");

const menu = document.getElementById("menu");
const menuButtons = document.querySelectorAll("button[data-diff]");

const questionBox = document.getElementById("questionBox");
const questionText = document.getElementById("questionText");
const optionButtons = document.querySelectorAll(".optionBtn");

const musicToggleBtn = document.getElementById("musicToggleBtn");
const testSoundBtn   = document.getElementById("testSoundBtn");

let gameState = "menu";
let currentDifficultyKey = null;
let frameCount = 0;
let obstacles = [];
let score = 0;

// niveles
let level = 1;
let isCelebrating = false;
let celebrationTimer = 0;
let celebrationBaseY = 0;

let usedQuestionIndices = new Set();
let currentQuestionIndex = null;

const gravity = 0.35;
const jumpStrength = -6.8;

const bird = {
  const bird = {
  x: 120,
  y: canvas.height / 2,
  vy: 0,
  width: 50,
  height: 38
};


const difficultyConfig = {
  facil:  { label:"F√°cil",  speed:2.2, gapHeight:150, spawnInterval:140 },
  medio:  { label:"Medio",  speed:3.1, gapHeight:125, spawnInterval:120 },
  dificil:{ label:"Dif√≠cil",speed:3.9, gapHeight:105, spawnInterval:105 }
};

let currentDifficulty = null;

//////////////////////////////
// FUNCIONES DEL JUEGO
//////////////////////////////

function resetRunKeepQuestions() {
  frameCount = 0;
  score = 0;
  obstacles = [];

  bird.x = 80;
  bird.y = canvas.height / 2;
  bird.vy = 0;

  level = 1;
  isCelebrating = false;
  celebrationTimer = 0;
  celebrationBaseY = bird.y;

  scoreLabel.textContent = "Puntos: 0";
}

function goToMenu() {
  gameState = "menu";
  resetRunKeepQuestions();
  usedQuestionIndices.clear();
  questionBox.style.display = "none";
  hud.style.display = "none";
  menu.style.display = "flex";
  difficultyLabel.textContent = "Dificultad: -";
  draw();
}

function startGame(diffKey) {
  currentDifficultyKey = diffKey;
  currentDifficulty = difficultyConfig[diffKey];
  difficultyLabel.textContent = "Dificultad: " + currentDifficulty.label;

  resetRunKeepQuestions();
  usedQuestionIndices.clear();

  hud.style.display = "flex";
  menu.style.display = "none";
  questionBox.style.display = "none";

  ensureMusicPlaying();

  gameState = "playing";
  loop();
}

function askQuestion() {
  const available = [...questionsPool.keys()].filter(i => !usedQuestionIndices.has(i));
  if (available.length === 0) {
    alert("¬°Contestaste todas las preguntas! üéâ");
    goToMenu();
    return;
  }

  currentQuestionIndex = available[Math.floor(Math.random() * available.length)];
  usedQuestionIndices.add(currentQuestionIndex);

  const q = questionsPool[currentQuestionIndex];
  questionText.textContent = q.text;

  optionButtons.forEach((btn, idx) => {
    if (q.options[idx]) {
      btn.textContent = q.options[idx];
      btn.style.display = "block";
    } else {
      btn.style.display = "none";
    }
  });

  try {
    sfxHit.currentTime = 0;
    sfxHit.play();
  } catch (e) {}

  questionBox.style.display = "flex";
  gameState = "question";

  if (musicEnabled && musicStarted) {
    fadeMusicTo(0.05, 600);
  }
}

function handleAnswer(selectedIndex) {
  const q = questionsPool[currentQuestionIndex];
  if (!q) return;

  if (selectedIndex === q.correctIndex) {
    questionBox.style.display = "none";
    alert("¬°Respuesta correcta! El pajarito vuelve a volar üê¶‚ú®");

    resetRunKeepQuestions();
    gameState = "playing";
    hud.style.display = "flex";

    if (musicEnabled && musicStarted) {
      fadeMusicTo(musicBaseVolume, 600);
    }

    loop();
  } else {
    alert("Respuesta incorrecta. Fin del juego üê¶üí•");
    goToMenu();
  }
}

function flap() {
  if (gameState === "playing") {
    bird.vy = jumpStrength;
    ensureMusicPlaying();
    try {
      sfxFlap.currentTime = 0;
      sfxFlap.play();
    } catch (e) {}
  }
}

function spawnObstacle() {
  const gh = currentDifficulty.gapHeight;
  const margin = 40;
  const centerY = margin + gh / 2 + Math.random() * (canvas.height - 2 * margin - gh);

  obstacles.push({
    x: canvas.width + 20,
    width: 50,
    gapY: centerY,
    gapHeight: gh,
    passed: false
  });
}

function checkLevelUp() {
  // Nivel 1 -> Nivel 2 (F√°cil -> Medio) al llegar a 15 puntos (solo si empez√≥ en F√°cil)
  if (currentDifficultyKey === "facil" && level === 1 && score >= 15 && !isCelebrating) {
    level = 2;
    isCelebrating = true;
    celebrationTimer = 0;
    celebrationBaseY = bird.y;
    obstacles = [];
    bird.vy = 0;

    alert("¬°Felicitaciones! Pasaste al Nivel 2 (Medio) üéâ");

    gameState = "celebration";
    loop();
    return;
  }

  // Nivel 2 -> Nivel 3 (Medio -> Dif√≠cil) al llegar a 30 puntos (viniendo del nivel 1)
  if (level === 2 && score >= 30 && !isCelebrating) {
    level = 3;
    isCelebrating = true;
    celebrationTimer = 0;
    celebrationBaseY = bird.y;
    obstacles = [];
    bird.vy = 0;

    alert("¬°Nivel M√°ximo! Ahora jug√°s en Dif√≠cil üí•");

    gameState = "celebration";
    loop();
    return;
  }
}

function updateObstacles() {
  const speed = currentDifficulty.speed;

  obstacles.forEach(o => {
    o.x -= speed;

    if (!o.passed && o.x + o.width < bird.x) {
      o.passed = true;
      score++;
      scoreLabel.textContent = "Puntos: " + score;

      try {
        sfxScore.currentTime = 0;
        sfxScore.play();
      } catch (e) {}

      checkLevelUp();
    }
  });

  obstacles = obstacles.filter(o => o.x + o.width > -20);

  if (frameCount % currentDifficulty.spawnInterval === 0) spawnObstacle();
}

function checkCollisions() {
  if (bird.y < 0 || bird.y + bird.height > canvas.height) {
    askQuestion();
    return;
  }

  for (const o of obstacles) {
    const topH = o.gapY - o.gapHeight / 2;
    const bottomY = o.gapY + o.gapHeight / 2;

    const bx1 = bird.x;
    const bx2 = bird.x + bird.width;
    const by1 = bird.y;
    const by2 = bird.y + bird.height;

    const ox1 = o.x;
    const ox2 = o.x + o.width;

    const overlapX = bx2 > ox1 && bx1 < ox2;
    const hitsTop = by1 < topH;
    const hitsBottom = by2 > bottomY;

    if (overlapX && (hitsTop || hitsBottom)) {
      askQuestion();
      return;
    }
  }
}

function drawBackground() {
  ctx.fillStyle = "#63c368";
  ctx.fillRect(0, canvas.height - 28, canvas.width, 28);
}

function drawBird() {
  const { x, y, width, height } = bird;

  ctx.save();

  const angle = Math.max(-0.4, Math.min(0.4, bird.vy * 0.03));
  ctx.translate(x + width / 2, y + height / 2);
  ctx.rotate(angle);

  ctx.fillStyle = "#d62828";
  ctx.beginPath();
  ctx.ellipse(0, 0, width / 2 + 2, height / 2 + 4, 0, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#ffffff";
  ctx.beginPath();
  ctx.ellipse(0, height * 0.15, width / 2.1, height / 2.4, 0, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#b21f2b";
  ctx.beginPath();
  ctx.moveTo(-4, -height / 2 - 2);
  ctx.lineTo(2, -height / 2 - 8);
  ctx.lineTo(8, -height / 2 - 2);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "#111111";
  ctx.beginPath();
  ctx.moveTo(-width / 2 - 6, 4);
  ctx.lineTo(-width / 2 - 1, -2);
  ctx.lineTo(-width / 2 + 3, 6);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "#00ff55";
  ctx.beginPath();
  ctx.moveTo(-width / 2 - 2, 2);
  ctx.lineTo(-width / 2 - 8, -2);
  ctx.lineTo(-width / 2 - 4, 6);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "#ffd52e";
  ctx.beginPath();
  ctx.moveTo(width / 2 + 2, 0);
  ctx.lineTo(width / 2 + 10, -4);
  ctx.lineTo(width / 2 + 10, 4);
  ctx.closePath();
  ctx.fill();

  const eyeX = width * 0.15;
  const eyeY = -height * 0.15;

  ctx.fillStyle = "#ffffff";
  ctx.beginPath();
  ctx.arc(eyeX, eyeY, 4.5, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#000000";
  ctx.beginPath();
  ctx.arc(eyeX + 1, eyeY + 0.5, 2.1, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#111111";
  ctx.save();
  ctx.translate(eyeX - 3, eyeY - 5);
  ctx.rotate(-0.2);
  ctx.fillRect(0, 0, 10, 2.5);
  ctx.restore();

  ctx.restore();
}

function drawObstacles() {
  ctx.fillStyle = "#0f766e";
  for (const o of obstacles) {
    const topH = o.gapY - o.gapHeight / 2;
    const bottomY = o.gapY + o.gapHeight / 2;

    ctx.fillRect(o.x, 0, o.width, topH);
    ctx.fillRect(o.x, bottomY, o.width, canvas.height - bottomY);
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBackground();
  drawObstacles();
  drawBird();
}

function loop() {
  if (gameState === "playing") {
    frameCount++;
    bird.vy += gravity;
    bird.y += bird.vy;
    updateObstacles();
    checkCollisions();
  } else if (gameState === "celebration") {
    celebrationTimer++;
    bird.vy = 0;
    bird.y = celebrationBaseY + Math.sin(celebrationTimer * 0.3) * 10;

    if (celebrationTimer > 120) { // ~2 segundos de baile
      isCelebrating = false;
      gameState = "playing";
      frameCount = 0;
      obstacles = [];
      bird.vy = 0;

      if (level === 2) {
        currentDifficultyKey = "medio";
        currentDifficulty = difficultyConfig["medio"];
      } else if (level === 3) {
        currentDifficultyKey = "dificil";
        currentDifficulty = difficultyConfig["dificil"];
      }

      if (musicEnabled && musicStarted) {
        fadeMusicTo(musicBaseVolume, 500);
      }
    }
  }

  draw();

  if (gameState === "playing" || gameState === "celebration") {
    requestAnimationFrame(loop);
  }
}

//////////////////////////////
// EVENTOS: juego
//////////////////////////////

menuButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    startGame(btn.dataset.diff);
  });
});

optionButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    const idx = Number(btn.dataset.index);
    if (gameState === "question") handleAnswer(idx);
  });
});

window.addEventListener("keydown", e => {
  if (e.code === "Space") {
    e.preventDefault();
    flap();
  }
});

canvas.addEventListener("mousedown", flap);
canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  flap();
}, { passive: false });

//////////////////////////////
// EVENTOS: m√∫sica
//////////////////////////////

function updateMusicToggleLabel() {
  musicToggleBtn.textContent = musicEnabled ? "üéµ M√∫sica: ON" : "üéµ M√∫sica: OFF";
}

musicToggleBtn.addEventListener("click", () => {
  musicEnabled = !musicEnabled;
  updateMusicToggleLabel();

  if (musicEnabled) {
    ensureMusicPlaying();
  } else if (musicStarted) {
    fadeMusicTo(0, 800, true);
  }
});

testSoundBtn.addEventListener("click", () => {
  ensureMusicPlaying();
  try {
    sfxScore.currentTime = 0;
    sfxScore.play();
  } catch (e) {}
});

updateMusicToggleLabel();
draw();
</script>
</body>
</html>
